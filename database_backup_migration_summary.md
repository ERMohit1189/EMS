# database_backup.sql — Migration Summary

This file lists updates applied to `database_backup.sql` so it matches repository migrations.

## Changes made
- employees
  - Made `blood_group`, `marital_status`, and `nominee` nullable (removed NOT NULL).
  - Added `emp_code` (character varying) with default `"EMP" || lpad(nextval('public.empcode_seq')::text, 5, '0')`; added idempotent migration `server/migrations/20251221_add_emp_code_to_employees.sql` to create the sequence, backfill existing rows, and add unique index `employees_emp_code_key`.

- attendances
  - Added `submitted BOOLEAN DEFAULT false` column to the table definition. Existing COPY rows are unchanged; new rows will have default value.
  - Added lock fields: `locked BOOLEAN DEFAULT false`, `locked_at TIMESTAMP`, `locked_by VARCHAR` and documentation comments.

- daily_allowances
  - Added `approval_history TEXT` column.
  - Added comment for the column: `JSON array of approval records: [{approverId, approverName, approverLevel, remark, editedData, timestamp}]`.

- salary_structures
  - Added these columns:
    - `month INTEGER NOT NULL DEFAULT 1`
    - `year INTEGER NOT NULL DEFAULT 2025`
    - `gross_salary NUMERIC(12,2)`
    - `per_day_salary NUMERIC(12,2)`
    - `earned_salary NUMERIC(12,2)`
    - `total_deductions NUMERIC(12,2)`
    - `net_salary NUMERIC(12,2)`
    - `total_days INTEGER`
    - `present_days INTEGER`
    - `half_days INTEGER`
    - `absent_days INTEGER`
    - `leave_days INTEGER`
    - `working_days NUMERIC(5,2)`

- sites
  - Added `state CHARACTER VARYING` column.
  - Added `partner_code CHARACTER VARYING` column and index `idx_sites_partner_code`.
  - Added indexes:
    - `idx_sites_state` on `(state)`
    - `idx_sites_state_created` on `(state, created_at DESC)`

- new tables added
  - `session` — session store table for connect-pg-simple; added `session_pkey`, `idx_session_sid` and `idx_session_expire`.
  - `generate_salary` — generated salary rows for employees; added `generate_salary_pkey`, `idx_generated_salary_employee_month`, and FK to `employees(id)`.
  - `vendor_rates` — vendor-specific antenna rates; added `vendor_rates_pkey`, unique constraint `(vendor_id, antenna_size)`, `idx_vendor_rate_vendor`, and FK to `vendors(id)`.
  - `leave_allotment_override_audits` — audit records for leave allotment overrides; added `leave_allotment_override_audits_pkey` and `idx_leave_allotment_override_employee_year`.
  - `leave_allotments` — per-employee annual leave allocations; added `leave_allotments_pkey`, `leave_allotments_employee_year_key` (unique employee/year), `idx_leave_employee_year`, and FK to `employees(id)` (ON DELETE CASCADE).
  - `leave_requests` — employee leave requests; added `leave_requests_pkey`, `idx_leave_requests_employee`, `idx_leave_requests_status`, FK to `employees(id)`, and new column `approver_remark TEXT` (used to store approver comments).
  - `holidays` — holiday master table; added `holidays_pkey`, `idx_holiday_date`, `idx_holiday_state`, and column comments for `state` and `type`.

## Notes & considerations
- Existing COPY data blocks were not modified. When restoring this dump, newly added columns will receive their default values (or NULL) for existing rows.
- I intentionally did not change `database_backup - Copy.sql`; only `database_backup.sql` was updated as requested.
- Recommended validation steps after restore:
  1. Restore dump to a test database: `psql -d testdb -f database_backup.sql`
  2. Confirm schema changes with queries against `information_schema.columns`.
  3. Sanity-check defaults: `SELECT COUNT(*) FROM attendances WHERE submitted IS NULL;` (should be 0 because default false)
  4. Verify indexes exist: `\d+ public.sites` and `SELECT indexname FROM pg_indexes WHERE tablename='sites';`

If you'd like, I can run a quick syntax check (`pg_restore --schema-only` or `psql --set ON_ERROR_STOP=on -f`) or prepare an idempotent ALTER script that makes these changes rather than modifying the dump.

- **Superadmin password**: Added `server/scripts/set-superadmin-password.js` to generate a strong password, hash it, update the DB, and optionally patch `database_backup.sql` and write a migration file. Run with:

  ```bash
  # generate a password, update DB and dump
  node server/scripts/set-superadmin-password.js --generate --update-dump --write-migration
  ```

  The script will print the plain password exactly once — copy it securely and remove it from env afterwards.

---
Generated by migration automation on 2025-12-21.