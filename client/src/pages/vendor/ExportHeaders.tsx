import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { toast } from "sonner";
import { getApiBaseUrl } from "@/lib/api";

type ExportHeader = {
  id: string;
  companyName: string | null;
  reportTitle: string | null;
  footerText: string | null;
  contactPhone: string | null;
  contactEmail: string | null;
  website: string | null;
  gstin: string | null;
  address: string | null;
  state: string | null;
  city: string | null;
  showGeneratedDate: boolean;
};

const INDIAN_STATES = [
  "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh",
  "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand",
  "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur",
  "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab",
  "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura",
  "Uttar Pradesh", "Uttarakhand", "West Bengal", "Delhi", "Puducherry"
];

const MAJOR_CITIES = [
  "Bangalore", "Mumbai", "Delhi", "Hyderabad", "Chennai", "Kolkata",
  "Pune", "Ahmedabad", "Jaipur", "Lucknow", "Kanpur", "Nagpur",
  "Indore", "Thane", "Bhopal", "Visakhapatnam", "Patna", "Vadodara",
  "Ghaziabad", "Ludhiana", "Coimbatore", "Kochi", "Chandigarh", "Surat",
  "Rajkot", "Kakinada", "Kota", "Makasar", "Agra", "Jabalpur"
];

const FOOTER_SUGGESTIONS = [
  {
    label: 'Professional & Formal',
    text: 'This document contains confidential and proprietary information. Unauthorized distribution or reproduction is strictly prohibited. For inquiries, contact your system administrator.'
  },
  {
    label: 'Brief & Clean',
    text: 'Confidential - For authorized use only. Document generated by EMS Portal. For questions, contact support.'
  },
  {
    label: 'Complete Information',
    text: 'CONFIDENTIAL: This report contains proprietary business information. Reproduction or distribution without authorization is prohibited. Â© 2025 Enterprise Management System. All rights reserved.'
  },
  {
    label: 'Compliance Focused',
    text: 'This is an official document generated by the EMS Portal. Please verify data accuracy before making business decisions. Report validity: Current as of generation date only.'
  },
  {
    label: 'Simple & Direct',
    text: 'Generated by EMS Portal - Confidential. For internal use only. Do not distribute without authorization.'
  }
];

export default function ExportHeaders() {
  const [header, setHeader] = useState<ExportHeader>({
    id: '',
    companyName: '',
    reportTitle: '',
    footerText: '',
    contactPhone: '',
    contactEmail: '',
    website: '',
    gstin: '',
    address: '',
    state: '',
    city: '',
    showGeneratedDate: true,
  });
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});

  const validatePhone = (value: string): string => {
    if (!value) return '';
    if (value.length > 10) return 'Contact phone must be 10 digits or less';
    if (!/^\d*$/.test(value)) return 'Contact phone must contain only digits';
    return '';
  };

  const validateEmail = (value: string): string => {
    if (!value) return '';
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return 'Invalid email format';
    return '';
  };

  const validateWebsite = (value: string): string => {
    if (!value) return '';
    if (!/^https?:\/\/.+/.test(value)) return 'Website must start with http:// or https://';
    return '';
  };

  const validateGSTIN = (value: string): string => {
    if (!value) return '';
    if (!/^[0-9A-Z]{15}$/.test(value)) return 'GSTIN must be 15 alphanumeric characters';
    return '';
  };

  const handleBlur = (field: string, value: string) => {
    let error = '';
    if (field === 'contactPhone') error = validatePhone(value);
    else if (field === 'contactEmail') error = validateEmail(value);
    else if (field === 'website') error = validateWebsite(value);
    else if (field === 'gstin') error = validateGSTIN(value);

    setErrors(prev => ({
      ...prev,
      [field]: error
    }));
  };

  useEffect(() => {
    loadHeader();
  }, []);

  const loadHeader = async () => {
    try {
      const response = await fetch(`${getApiBaseUrl()}/api/export-headers`);
      if (response.ok) {
        const data = await response.json();
        setHeader(data || { id: '', companyName: '', reportTitle: '', footerText: '', contactPhone: '', contactEmail: '', website: '', gstin: '', address: '', state: '', city: '', showGeneratedDate: true });
      }
    } catch (error) {
      console.error('Failed to load header settings:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      const response = await fetch(`${getApiBaseUrl()}/api/export-headers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          companyName: header.companyName || null,
          reportTitle: header.reportTitle || null,
          footerText: header.footerText || null,
          contactPhone: header.contactPhone || null,
          contactEmail: header.contactEmail || null,
          website: header.website || null,
          gstin: header.gstin || null,
          address: header.address || null,
          state: header.state || null,
          city: header.city || null,
          showGeneratedDate: header.showGeneratedDate,
        }),
      });

      if (response.ok) {
        toast({ title: 'Success', description: 'Export header settings saved', variant: 'default' });
        setErrors({});
      } else {
        const errorData = await response.json();
        const errorMessage = errorData.error || 'Failed to save settings';
        toast({ title: 'Error', description: errorMessage, variant: 'destructive' });
      }
    } catch (error: any) {
      const errorMessage = error.message || 'Failed to save settings';
      toast({ title: 'Error', description: errorMessage, variant: 'destructive' });
    } finally {
      setSaving(false);
    }
  };

  if (loading) return <div className="text-center py-10">Loading...</div>;

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl md:text-3xl font-bold tracking-tight" data-testid="title-export-headers">Export Header Settings</h1>
        <p className="text-xs md:text-sm text-muted-foreground mt-2">Configure headers and footers for Excel and PDF exports</p>
      </div>

      <div className="bg-white rounded-lg border border-gray-200 p-3 md:p-6 space-y-3 md:space-y-4">
        <div>
          <Label htmlFor="company-name" className="text-xs md:text-sm">Company Name</Label>
          <Input
            id="company-name"
            data-testid="input-company-name"
            value={header.companyName || ''}
            onChange={(e) => setHeader({ ...header, companyName: e.target.value })}
            placeholder="Enter company name"
            className="mt-1 text-xs md:text-sm h-8 md:h-auto"
          />
        </div>

        <div>
          <Label htmlFor="report-title" className="text-xs md:text-sm">Report Title</Label>
          <Input
            id="report-title"
            data-testid="input-report-title"
            value={header.reportTitle || ''}
            onChange={(e) => setHeader({ ...header, reportTitle: e.target.value })}
            placeholder="e.g., Site Status Report"
            className="mt-1 text-xs md:text-sm h-8 md:h-auto"
          />
        </div>

        <div className="grid grid-cols-2 gap-2 md:gap-4">
          <div>
            <Label htmlFor="contact-phone" className="text-xs md:text-sm">Contact Phone</Label>
            <Input
              id="contact-phone"
              data-testid="input-contact-phone"
              type="tel"
              maxLength={10}
              value={header.contactPhone || ''}
              onChange={(e) => setHeader({ ...header, contactPhone: e.target.value })}
              onBlur={(e) => handleBlur('contactPhone', e.target.value)}
              placeholder="e.g., 9876543210"
              className={`mt-1 text-xs md:text-sm h-8 md:h-auto ${errors.contactPhone ? 'border-red-500' : ''}`}
            />
            {errors.contactPhone && (
              <p className="text-xs text-red-600 mt-1 font-medium" data-testid="error-contact-phone">{errors.contactPhone}</p>
            )}
            {!errors.contactPhone && (
              <p className="text-xs text-gray-500 mt-1">Max 10 digits</p>
            )}
          </div>

          <div>
            <Label htmlFor="contact-email" className="text-xs md:text-sm">Email Address</Label>
            <Input
              id="contact-email"
              data-testid="input-contact-email"
              type="email"
              value={header.contactEmail || ''}
              onChange={(e) => setHeader({ ...header, contactEmail: e.target.value })}
              onBlur={(e) => handleBlur('contactEmail', e.target.value)}
              placeholder="e.g., support@company.com"
              className={`mt-1 text-xs md:text-sm h-8 md:h-auto ${errors.contactEmail ? 'border-red-500' : ''}`}
            />
            {errors.contactEmail && (
              <p className="text-xs text-red-600 mt-1 font-medium" data-testid="error-contact-email">{errors.contactEmail}</p>
            )}
            {!errors.contactEmail && (
              <p className="text-xs text-gray-500 mt-1">Valid email format required</p>
            )}
          </div>

          <div>
            <Label htmlFor="website" className="text-xs md:text-sm">Website</Label>
            <Input
              id="website"
              data-testid="input-website"
              type="url"
              value={header.website || ''}
              onChange={(e) => setHeader({ ...header, website: e.target.value })}
              onBlur={(e) => handleBlur('website', e.target.value)}
              placeholder="e.g., https://www.company.com"
              className={`mt-1 text-xs md:text-sm h-8 md:h-auto ${errors.website ? 'border-red-500' : ''}`}
            />
            {errors.website && (
              <p className="text-xs text-red-600 mt-1 font-medium" data-testid="error-website">{errors.website}</p>
            )}
            {!errors.website && (
              <p className="text-xs text-gray-500 mt-1">Valid URL format required</p>
            )}
          </div>

          <div>
            <Label htmlFor="gstin" className="text-xs md:text-sm">GSTIN</Label>
            <Input
              id="gstin"
              data-testid="input-gstin"
              maxLength={15}
              value={header.gstin || ''}
              onChange={(e) => setHeader({ ...header, gstin: e.target.value.toUpperCase() })}
              onBlur={(e) => handleBlur('gstin', e.target.value)}
              placeholder="e.g., 27AABCT1234H1Z0"
              className={`mt-1 text-xs md:text-sm h-8 md:h-auto ${errors.gstin ? 'border-red-500' : ''}`}
              pattern="^[0-9A-Z]{15}$"
              title="GSTIN must be 15 alphanumeric characters"
            />
            {errors.gstin && (
              <p className="text-xs text-red-600 mt-1 font-medium" data-testid="error-gstin">{errors.gstin}</p>
            )}
            {!errors.gstin && (
              <p className="text-xs text-gray-500 mt-1">15 alphanumeric characters</p>
            )}
          </div>
        </div>

        <div>
          <Label htmlFor="address" className="text-xs md:text-sm">Address</Label>
          <Input
            id="address"
            data-testid="input-address"
            value={header.address || ''}
            onChange={(e) => setHeader({ ...header, address: e.target.value })}
            placeholder="e.g., 123 Business Street, Postal Code"
            className="mt-1 text-xs md:text-sm h-8 md:h-auto"
          />
        </div>

        <div className="grid grid-cols-2 gap-2 md:gap-4">
          <div>
            <Label htmlFor="state" className="text-xs md:text-sm">State</Label>
            <Select value={header.state || ''} onValueChange={(value) => setHeader({ ...header, state: value })}>
              <SelectTrigger id="state" data-testid="select-state" className="mt-1 text-xs md:text-sm h-8 md:h-auto">
                <SelectValue placeholder="Select a state" />
              </SelectTrigger>
              <SelectContent>
                {INDIAN_STATES.map((s) => (
                  <SelectItem key={s} value={s}>{s}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label htmlFor="city" className="text-xs md:text-sm">City</Label>
            <Select value={header.city || ''} onValueChange={(value) => setHeader({ ...header, city: value })}>
              <SelectTrigger id="city" data-testid="select-city" className="mt-1 text-xs md:text-sm h-8 md:h-auto">
                <SelectValue placeholder="Select a city" />
              </SelectTrigger>
              <SelectContent>
                {MAJOR_CITIES.map((c) => (
                  <SelectItem key={c} value={c}>{c}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        <div>
          <Label htmlFor="footer-text" className="text-xs md:text-sm">Footer Text</Label>
          <Textarea
            id="footer-text"
            data-testid="input-footer-text"
            value={header.footerText || ''}
            onChange={(e) => setHeader({ ...header, footerText: e.target.value })}
            placeholder="Enter footer text (e.g., confidential notice, contact info)"
            className="mt-1 min-h-24 text-xs md:text-sm"
          />
          
          <div className="mt-3">
            <p className="text-xs md:text-sm font-medium mb-2">Or select a suggested footer:</p>
            <div className="space-y-2">
              {FOOTER_SUGGESTIONS.map((suggestion, index) => (
                <button
                  key={index}
                  data-testid={`button-footer-suggestion-${index}`}
                  onClick={() => setHeader({ ...header, footerText: suggestion.text })}
                  className="w-full text-left p-2 md:p-3 border border-gray-200 rounded hover:bg-blue-50 hover:border-blue-300 transition"
                >
                  <div className="flex justify-between items-start gap-2">
                    <div>
                      <p className="font-medium text-xs md:text-sm">{suggestion.label}</p>
                      <p className="text-xs text-gray-600 line-clamp-2">{suggestion.text}</p>
                    </div>
                    <Badge variant="outline" className="text-xs shrink-0">Select</Badge>
                  </div>
                </button>
              ))}
            </div>
          </div>
        </div>

        <div className="flex items-center space-x-2">
          <input
            type="checkbox"
            id="show-date"
            data-testid="checkbox-show-date"
            checked={header.showGeneratedDate}
            onChange={(e) => setHeader({ ...header, showGeneratedDate: e.target.checked })}
            className="cursor-pointer w-4 h-4"
          />
          <Label htmlFor="show-date" className="cursor-pointer text-xs md:text-sm">Show Generated Date in Exports</Label>
        </div>
      </div>

      <Button 
        onClick={handleSave}
        disabled={saving}
        data-testid="button-save-settings"
        className="bg-blue-600 hover:bg-blue-700 text-xs md:text-sm h-8 md:h-auto"
      >
        {saving ? 'Saving...' : 'Save Settings'}
      </Button>

      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4 mt-6">
        <p className="text-xs md:text-sm font-semibold text-blue-900 mb-3">ðŸ“‹ Preview:</p>
        <div className="bg-white border border-blue-100 rounded p-2 md:p-3 space-y-2 text-xs md:text-sm">
          {header.companyName && (
            <div className="text-blue-900"><strong>Company:</strong> {header.companyName}</div>
          )}
          {header.address && (
            <div className="text-blue-900"><strong>Address:</strong> {header.address}</div>
          )}
          {header.state && (
            <div className="text-blue-900"><strong>State:</strong> {header.state}</div>
          )}
          {header.city && (
            <div className="text-blue-900"><strong>City:</strong> {header.city}</div>
          )}
          {header.contactPhone && (
            <div className="text-blue-900"><strong>Phone:</strong> {header.contactPhone}</div>
          )}
          {header.contactEmail && (
            <div className="text-blue-900"><strong>Email:</strong> {header.contactEmail}</div>
          )}
          {header.website && (
            <div className="text-blue-900"><strong>Website:</strong> {header.website}</div>
          )}
          {header.gstin && (
            <div className="text-blue-900"><strong>GSTIN:</strong> {header.gstin}</div>
          )}
          {header.reportTitle && (
            <div className="text-blue-900"><strong>Report:</strong> {header.reportTitle}</div>
          )}
          {header.footerText && (
            <div className="text-gray-700 border-t border-gray-200 pt-2 mt-2 italic">
              <strong>Footer:</strong> {header.footerText}
            </div>
          )}
          {header.showGeneratedDate && (
            <div className="text-gray-600">
              <strong>Generated:</strong> {new Date().toLocaleString()}
            </div>
          )}
          {!header.companyName && !header.reportTitle && !header.footerText && !header.contactPhone && !header.contactEmail && !header.website && !header.gstin && !header.address && !header.state && !header.city && (
            <div className="text-gray-400">No settings configured yet. Your exports will show any headers and footers you add here.</div>
          )}
        </div>
      </div>
    </div>
  );
}
